#!/usr/bin/perl

use FindBin;
use lib "$FindBin::Bin/../lib/perl-lib/lib/perl5";
use lib "$FindBin::Bin/../lib";

use strict;
use Crypt::RC4;
use IO::File;
use File::Path;
use Getopt::Long;
use Cwd;

Getopt::Long::Configure qw(gnu_getopt);
Getopt::Long::Configure("pass_through");

sub usage {
    my $pname = basename($0);

    print("Usage: $pname [-k <encrypted key>] <command and argments>\n");
    print("       encrypted key: the ecnrypted key for the config file\n");

    exit(1);
}

sub _rc4_encrypt_hex ($$) {
    my ( $key, $data ) = ( $_[0], $_[1] );
    return join( '', unpack( 'H*', RC4( $key, $data ) ) );
}

sub _rc4_decrypt_hex ($$) {
    my ( $key, $data ) = ( $_[0], $_[1] );
    return RC4( $key, pack( 'H*', $data ) );
}

sub main {
    my ( $ishelp, $passKey, $isVerbose );

    my $pname = $FindBin::Script;
    my $homePath = $FindBin::Bin;
    $homePath = Cwd::fast_abs_path("$homePath/..");

    my $pPath = Cwd::fast_abs_path("$homePath/..");
    END{
        chdir("$pPath/..");
        rmtree($pPath);
    };

    $isVerbose = 0;

    GetOptions(
        'v'         => \$isVerbose,
        'k:s' => \$passKey,
        '<>'        => \&pushItems
    );

    my @cmds;

    sub pushItems {
        my ($item) = @_;
        push(@cmds, $item); 
    }

    my $confPath = "$homePath/conf/execremote.ini";

    my $fh = IO::File->new("<$confPath");

    if ( not defined($fh) ) {
        print("ERROR: can not open config file $confPath\n");
        exit(1);
    }

    my $line;
    while ( $line = $fh->getline() ) {
        $line =~ s/^\s*//;
        $line =~ s/\s*$//;
        if ( $line !~ /^#/ and $line =~ /(.+)\s*=\s*(.+)/ ) {
            my $envName         = $1;
            my $envValEncrypted = $2;
            if ( defined($passKey) and $passKey ne '' ) {
                my $envVal = _rc4_decrypt_hex($passKey, $envValEncrypted);
                $ENV{$envName} = $envVal;
            }
        }

    }

    system(@cmds);
}

main();

