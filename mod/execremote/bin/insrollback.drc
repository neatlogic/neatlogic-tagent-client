#!/usr/bin/perl

use FindBin;
use lib "$FindBin::Bin/../lib/perl-lib/lib/perl5";
use lib "$FindBin::Bin/../lib";

use strict;
use Getopt::Long;
use File::Basename;

our $pname = basename($0);

sub usage {
    print("Usage: $pname [--prefix <prefix>] [--backupdir <backupdir>] [--rollbackdir <rollbackdir>] \n");
    print("        prefix: prefix name of archive \n");
    print("        backupdir: backup path \n");

    exit(1);
}

sub main {
    my ( $prefix, $backupDir, $rollbackDir );
    GetOptions(
        'prefix:s'      => \$prefix,
        'backupdir:s'   => \$backupDir,
        'rollbackdir:s' => \$rollbackDir
    );

    if ( not defined($prefix) ) {
    	print("ERROR: Please input backup target parameters. \n");
    	usage();
    }
   
    if (not defined($backupDir) ) {
        $backupDir = "\$HOME/oldcx";
    }
   
    if (not defined($rollbackDir) ) {
        $rollbackDir = "\$HOME";
    }
   
    # 执行还原命令
    my $cmd = "cd $backupDir/\$(ls -t $backupDir | grep $prefix | head -1) && filePath=\$(pwd) && cd $rollbackDir && tar -xvf \$(ls -t \$filePath/$prefix" . "_*.tar | head -1)";
    my $ret = system($cmd);
    
    if ($ret eq 0) {
    	print("INFO: Rollback success.");
    }else {
    	print("ERROR: Rollback failure.");	
    	exit(1);
    }
   
}

main();
